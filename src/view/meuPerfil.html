<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Perfil</title>
    <link rel="stylesheet" href="/css/perfil.css">
</head>

<body>

    <header class="topo">
        <div class="logo">
            <a href="../view/inicio2.html">
                <img src="/imgs/banner-logo/CONECTA+.png" alt="Logo Conecta+">
            </a>
        </div>

        <h1>Meu Perfil</h1>

        <nav class="menu">
            <a href="../view/inicio.html">Início</a>
            <a href="../view/comunidade.html">Comunidade</a>
            <a href="../view/meusRelatos.html">Meus Relatos</a>
        </nav>
    </header>

    <main class="conteudo">
        <div class="perfil-card" id="perfil-card">
            <!-- Dados do perfil serão carregados aqui -->
        </div>

        <div class="acoes">
            <button onclick="editarPerfil()">Editar Perfil</button>
            <button onclick="deletarConta()">Deletar Conta</button>
            <button onclick="logout()">Sair</button>
        </div>
    </main>

    <footer class="rodape">
        <p><strong>Endereço:</strong> SC-401, 3730 - Saco Grande, Florianópolis - SC, 88032-005</p>
        <p><strong>Telefone:</strong> (48) 3239-5801</p>
        <p><strong>© 2025 Conecta+. Todos os direitos reservados.</strong></p>
    </footer>

    <script>
        function carregarPerfil() {
            const usuario = JSON.parse(localStorage.getItem("usuarioLogado"));
            const ong = JSON.parse(localStorage.getItem("ongLogada"));
            const card = document.getElementById("perfil-card");

            if (usuario) {
                card.innerHTML = `
          <p><strong>Nome:</strong> ${usuario.nome}</p>
          <p><strong>Email:</strong> ${usuario.email}</p>
          <p><strong>Bairro:</strong> ${usuario.bairro || "Não informado"}</p>
          <p><strong>Descrição:</strong> ${usuario.descricao || "Sem descrição"}</p>
          <p><strong>ID:</strong> ${usuario.id_user || "ID não encontrado"}</p>
        `;
            } else if (ong) {
                card.innerHTML = `
          <p><strong>Nome ONG:</strong> ${ong.nome}</p>
          <p><strong>Email:</strong> ${ong.email}</p>
          <p><strong>Área de atuação:</strong> ${ong.area_atuacao || "Não informado"}</p>
          <p><strong>Descrição:</strong> ${ong.descricao || "Sem descrição"}</p>
        `;
            } else {
                card.innerHTML = "<p>Nenhum perfil encontrado. Faça login novamente.</p>";
            }
        }

        async function deletarConta() {
            const usuario = JSON.parse(localStorage.getItem("usuarioLogado"));
            const ong = JSON.parse(localStorage.getItem("ongLogada"));

            if (!confirm("Tem certeza que deseja excluir sua conta?")) return;

            try {
                let resposta;
                if (usuario && usuario.id_user) {
                    resposta = await fetch(`http://localhost:3000/usuarioLDelet/${usuario.id_user}`, {
                        method: "DELETE"
                    });
                } else if (ong && ong.id_ong) {
                    resposta = await fetch(`http://localhost:3000/ongsDelete/${ong.id_ong}`, {
                        method: "DELETE"
                    });
                } else {
                    alert("ID não encontrado. Faça login novamente.");
                    return;
                }

                const resultado = await resposta.json();
                alert(resultado.message);

                localStorage.clear();
                window.location.href = "login.html";
            } catch (error) {
                console.error("Erro ao deletar conta:", error);
                alert("Erro ao deletar conta.");
            }
        }

        async function editarPerfil() {
            const usuario = JSON.parse(localStorage.getItem("usuarioLogado"));
            const ong = JSON.parse(localStorage.getItem("ongLogada"));

            const novoNome = prompt("Novo nome:");
            const novoEmail = prompt("Novo email:");
            const novaDescricao = prompt("Nova descrição:");

            if (!novoNome || !novoEmail) {
                alert("Preencha os campos corretamente.");
                return;
            }

            try {
                let resposta;
                if (usuario && usuario.id_user) {
                    resposta = await fetch(`http://localhost:3000/usuarioLUpdate/${usuario.id_user}`, {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            nome: novoNome,
                            email: novoEmail,
                            descricao: novaDescricao
                        })
                    });
                } else if (ong && ong.id_ong) {
                    resposta = await fetch(`http://localhost:3000/ongsUpdate/${ong.id_ong}`, {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            nome: novoNome,
                            email: novoEmail,
                            descricao: novaDescricao
                        })
                    });
                } else {
                    alert("ID não encontrado. Faça login novamente.");
                    return;
                }

                const resultado = await resposta.json();
                alert(resultado.message);

                if (usuario) {
                    usuario.nome = novoNome;
                    usuario.email = novoEmail;
                    usuario.descricao = novaDescricao;
                    localStorage.setItem("usuarioLogado", JSON.stringify(usuario));
                } else if (ong) {
                    ong.nome = novoNome;
                    ong.email = novoEmail;
                    ong.descricao = novaDescricao;
                    localStorage.setItem("ongLogada", JSON.stringify(ong));
                }

                carregarPerfil();
            } catch (error) {
                console.error("Erro ao editar perfil:", error);
                alert("Erro ao editar perfil.");
            }
        }

        function logout() {
            localStorage.clear();
            window.location.href = "login.html";
        }

        carregarPerfil();
    </script>

</body>

</html>