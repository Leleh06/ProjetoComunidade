<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meus Relatos</title>
    <link rel="stylesheet" href="/css/relatos.css">
</head>

<body>

    <header class="topo">
        <div class="logo">
            <a href="../view/inicio2.html">
                <img src="/imgs/banner-logo/CONECTA+.png" alt="Logo Conecta+">
            </a>
        </div>

        <h1>Meus relatos</h1>

        <nav class="menu">
            <a href="../view/inicio2.html">Início</a>
            <a href="../view/meuPerfil.html">Meu perfil</a>
            <a href="../view/comunidade.html">Comunidade</a>
        </nav>
    </header>

    <main class="conteudo">
        <div class="lista-relatos" id="lista-relatos"></div>
        <a class="botao-novo" href="../view/publicarRelato.html">Novo relato</a>
    </main>

    <footer class="rodape">
        <p><strong>Endereço:</strong> SC-401, 3730 - Saco Grande, Florianópolis - SC, 88032-005</p>
        <p><strong>Telefone:</strong> (48) 3239-5801</p>
        <p><strong>© 2025 Conecta+. Todos os direitos reservados.</strong></p>
    </footer>

    <script>
        async function carregarRelatos() {
            try {
                const resposta = await fetch("http://localhost:3000/relatoListar");
                const resultado = await resposta.json();

                const container = document.getElementById("lista-relatos");

                const relatosValidos = resultado.data.filter(r =>
                    r.descricao && r.descricao.length >= 10 && r.categoria
                );

                if (resposta.ok && relatosValidos.length > 0) {
                    container.innerHTML = relatosValidos.map(r => {
                        const textoLimpo = r.descricao.length > 300
                            ? r.descricao.slice(0, 300) + "..."
                            : r.descricao;

                        return `
              <div class="cartao">
                ${r.foto ? `<img src="data:image/jpeg;base64,${r.foto}" alt="Imagem relato">` : ""}
                <p><strong>${r.nome || "Anônimo"}</strong></p>
                <p><em>${r.categoria}</em></p>
                <p>${textoLimpo}</p>
                ${r.video ? `<video controls src="data:video/mp4;base64,${r.video}"></video>` : ""}
                <button onclick="editarRelato(${r.id_post})">Editar</button>
                <button onclick="deletarRelato(${r.id_post})">Excluir</button>
              </div>
            `;
                    }).join("");
                } else {
                    container.innerHTML = "<p>Você ainda não tem relatos válidos.</p>";
                }
            } catch (error) {
                console.error("Erro ao carregar relatos:", error);
                document.getElementById("lista-relatos").innerHTML = "<p>Erro ao carregar relatos.</p>";
            }
        }

        async function deletarRelato(id) {
            if (!confirm("Tem certeza que deseja excluir este relato?")) return;

            try {
                const resposta = await fetch(`http://localhost:3000/relatoDelet/${id}`, {
                    method: "DELETE"
                });
                const resultado = await resposta.json();
                alert(resultado.message);
                carregarRelatos();
            } catch (error) {
                console.error("Erro ao excluir relato:", error);
                alert("Erro ao excluir relato.");
            }
        }

        async function editarRelato(id) {
            const novoNome = prompt("Novo nome:");
            const novaCategoria = prompt("Nova categoria:");
            const novaDescricao = prompt("Nova descrição (mínimo 10 caracteres):");

            if (!novaDescricao || novaDescricao.length < 10) {
                alert("A descrição precisa ter pelo menos 10 caracteres.");
                return;
            }

            try {
                const resposta = await fetch(`http://localhost:3000/relatoUpdate/${id}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        nome: novoNome,
                        categoria: novaCategoria,
                        descricao: novaDescricao
                    })
                });
                const resultado = await resposta.json();
                alert(resultado.message);
                carregarRelatos();
            } catch (error) {
                console.error("Erro ao editar relato:", error);
                alert("Erro ao editar relato.");
            }
        }

        carregarRelatos();
    </script>

</body>

</html>